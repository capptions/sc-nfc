<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE
The complete set of authors may be found at http://polymer.github.io/AUTHORS
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS
-->
<link rel="import" href="../polymer/polymer.html" />

<dom-module id="sc-nfc">
  <template>
  </template>
</dom-module>

<script>
(function () {

  var NOOP = function () {};

  window.Polymer({
    is: 'sc-nfc',

    properties: {
      /**
       * A boolean indicating whether nfc is available or not
       *
       * @default false
       */
      available: {
        type: Boolean,
        value: false,
        readOnly: true,
        notify: true
      },

      /**
       * A boolean indicating whether nfc is enabled or not
       *
       * @default false
       */
      enabled: {
        type: Boolean,
        value: false,
        readOnly: true,
        notify: true
      },

      /**
       * A boolean to enable logs to be written to `console.log`
       *
       * @default false
       */
      debug: {
        type: Boolean,
        value: false
      }
    },

    log: function () {
      return this.debug && window.console.log.apply(window.console, arguments);
    },

    ready: function () {
      // Check if Capacitor NFC plugin is available
      if (!window.Capacitor || !window.Capacitor.Plugins || !window.Capacitor.Plugins.NFC) {
        this._setAvailable(false);
        this._setEnabled(false);
        return this.log('The Capacitor NFC plugin is not available');
      }

      this._setAvailable(true);

      this.library = this.library || {
        nfc: window.Capacitor.Plugins.NFC
      };

      var initialize = this.initialize.bind(this);
      document.removeEventListener('resume', initialize);
      document.addEventListener('resume', initialize, false);
      initialize();
    },

    initialize: function () {
      // Check if NFC is supported using the correct API
      this.library.nfc.isSupported().then(function (result) {
        if (result.supported) {
          this._setEnabled(true);
          this.log('NFC is supported and enabled');
          this.fire('enabled', true);
        } else {
          this._setEnabled(false);
          this.log('NFC is not supported');
          this.fire('enabled', false);
        }
      }.bind(this)).catch(function (error) {
        this._setEnabled(false);
        this._setAvailable(false);
        this.fire('enabled', false);
        this.log('NFC is not available:', error);
      }.bind(this));
    },

    listen: function (fn, stop) {
      if (!this.available || !this.enabled) {
        return this.log('NFC is not available or not enabled');
      }

      fn = fn || NOOP;
      stop = !!stop;

      this._callback = this._callback || function (tag) {
        this.log('NFC event received', tag);
        this.fire('exchange', tag);
      }.bind(this);

      if (stop) {
        return this.stopListening(fn);
      }

      return this.startListening(fn);
    },

    startListening: function (fn) {
      try {
        // Set up listeners for NFC events using Capacitor 7 API
        this.library.nfc.addListener('nfcTag', function (data) {
          this.log('NFC tag detected:', data);
          this._callback(data);
          // Stop listening after successful detection
          this.stopListening();
        }.bind(this));

        this.library.nfc.addListener('nfcError', function (error) {
          this.log('NFC error:', error);
          // Stop listening after error
          this.stopListening();
        }.bind(this));

        // Start NFC scanning
        this.library.nfc.startScan().then(function () {
          this.log('NFC scanning started');
          this.log('Listening started successfully');
          fn && fn();
        }.bind(this)).catch(function (error) {
          this.log('Failed to start NFC scanning:', error);
          fn && fn('failed');
        }.bind(this));
      } catch (error) {
        this.log('Listening start failed', error);
        fn && fn('failed');
      }
    },

    stopListening: function (fn) {
      try {
        // Remove all listeners using Capacitor 7 API
        this.library.nfc.removeAllListeners();

        this.log('Listening stopped successfully');
        fn && fn();
      } catch (error) {
        this.log('Listening stop failed', error);
        fn && fn('failed');
      }
    }
  });

})();
</script>
